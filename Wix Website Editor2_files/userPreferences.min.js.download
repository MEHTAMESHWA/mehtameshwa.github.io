define("userPreferences",["lodash","jquery","util","pLoader!santa:utils"],function(a,b,c,d){"use strict";var e=c.serviceTopology.premiumStateApiUrl;e=e?e.replace(/\/getTpaPremiumState/,"-user-preferences-webapp/"):"http://editor.wix.com/_api/wix-user-preferences-webapp/";var f="editorAppId";var g=3;var h=false;function i(){var i=null;var j={session:{id:"session",data:{}},site:{id:"site",data:{},urls:{getLoadUrl:function(){return e+"getVolatilePrefsForSite/htmlEditor/"+i},getSaveUrl:function(){return e+"bulkSet"},getDeleteUrl:function(){return e+"delete"}}},global:{id:"global",data:null,urls:{getLoadUrl:function(){return e+"getVolatilePrefForKey/htmlEditor/global_preferences"},getSaveUrl:function(){return e+"set"}}}};function k(){return c.url.isTrue("fakeUserPrefs")}function l(a){var b=c.url.getParameterByName("resetUserPrefs").toLowerCase();return b==="all"||b===a}function m(b,c,d){return a.mapValues(b,function(b){var e=a.isUndefined(d)?b:d;return{value:e,isDirty:c}})}function n(b){if(b.version===g){return m(b,true)}var c=a.assign({},a.omit(b,f,"version"),b[f]);z(b);c=a.transform(c,function(a,b,c){a[F(f,c)]=b},{});c.version=g;return m(c,true)}function o(a,b){switch(a){case j.global.id:return b.global_preferences;case j.site.id:return n(b);default:d.log.error("unknown type ID");return{}}}function p(a,b){j.global.data={};C(j.global.id,a,b)}function q(a,b){j.site.data=m(j.site.data,true,null);C(j.site.id,a,b)}function r(b){var c={nameSpace:"htmlEditor",siteId:i,data:{}};a.forEach(b,function(a,b){if(a.isDirty){c.data[b]=a.value}});c.data.version=g;return c}function s(a){return{nameSpace:"htmlEditor",key:a,siteId:i}}function t(a){return{nameSpace:"htmlEditor",key:"global_preferences",blob:a}}function u(a){switch(a){case j.global.id:return t(j.global.data);case j.site.id:return r(j.site.data)}}function v(b){switch(b){case j.global.id:return{global_preferences:j.global.data};case j.site.id:var c={};a.forEach(j.site.data,function(a,b){c[b]=a.value});c.version=g;return c;default:d.log.error("unknown type ID");return{}}}function w(a,b,c,d){j[a].data=b?o(a,b):{};if(l(a)){B(a,c,d)}else if(c){c()}}function x(b){if(b===j.site.id){a.forEach(j.site.data,function(a){a.isDirty=false})}}function y(a,c,d){if(k()){var e=window.sessionStorage.getItem("user_prefs_"+j[a].id);w(a,JSON.parse(e),c,d);return}b.ajax(j[a].urls.getLoadUrl(),{type:"GET",success:function(b){w(a,b,c,d)},error:function(a){if(d){d(a)}}})}function z(b){a.forEach(b,function(a,b){A(b)})}function A(a){if(k()){return}b.ajax(j[j.site.id].urls.getDeleteUrl(),{type:"POST",contentType:"application/json; charset=utf-8",data:JSON.stringify(s(a))})}function B(a,b,c){switch(a){case j.global.id:return p(b,c);case j.site.id:return q(b,c)}}function C(a,c,d){if(j[a].data===null){if(d){d("saving "+a+" preferences failed since they were not loaded")}return}if(k()){var e=v(a);window.sessionStorage.setItem("user_prefs_"+j[a].id,JSON.stringify(e));x(a);if(c){c()}return}if(h){return}var f=u(a);if(!f){if(c){c()}return}b.ajax(j[a].urls.getSaveUrl(),{type:"POST",contentType:"application/json; charset=utf-8",data:JSON.stringify(f),success:function(){x(a);if(c){c()}},error:function(a){if(a.status===413){h=true}if(d){d(a)}}})}function D(b,c){b=b||a.noop;c=c||a.noop;function e(a){function e(){if(a&&a.responseText){var b=a.responseText.match(/errorCode="(\d+)"/);b=b&&b[1];return b==="3001"}return false}if(e()){j.global.data={};b();return}j.global.data=null;d.log.error("Global preferences failed to load!");c("Global preferences failed to load!")}y(j.global.id,b,e)}function E(b,c,e,f){var g=a.isEmpty(j.site.data);i=b;var h=C.bind(this,j.site.id,e,f);if(c){if(!g){C(j.site.id,e,f)}}else if(g){y(j.site.id,h,function(){d.log.error("Site preferences failed to load!");if(f){f("Site preferences failed to load!")}})}else{var k=a.clone(j.site.data);var l=function(){j.site.data=a.merge(j.site.data,k);h()};y(j.site.id,l,function(){d.log.error("Site preferences failed to load!");h()})}}function F(a,b){return a+"_"+b}function G(b){return a.transform(j.site.data,function(a,c,d){var e=d.split("_");if(e[0]===b){a[e[1]]=c.value}},{})}return{loadGlobalPreferences:D,loadSitePreferences:E,global:{get:function(b){if(j.global.data===null){d.log.error("Global user preferences failed to load!");return null}if(!a.isString(b)){throw new Error("Getting a global user preference expects a key of type string but received: "+b)}return a.cloneDeep(j.global.data[b])},getAll:function(){if(j.global.data===null){d.log.error("Global user preferences failed to load!");return null}return a.cloneDeep(j.global.data)},set:function(b,c,e,f){if(j.global.data===null){d.log.error("Global user preferences failed to load!");if(f){f("Global user preferences failed to load!")}return}if(!a.isString(b)){throw new Error("Setting a global user preference expects a key of type string but received: "+b)}if(a.isUndefined(c)){c=null}j.global.data[b]=c;C(j.global.id,e,f)}},site:{get:function(b,c){c=c||f;if(!a.isString(b)){throw new Error("Getting a user preference for the site expects a key of type string but received: "+b)}var d=F(c,b);return a.cloneDeep(j.site.data[d]&&j.site.data[d].value)},getAll:function(){return G(f)},set:function(b,c,d,e,g){g=g||f;if(!a.isString(b)){throw new Error("Setting a user preference for the site expects a key of type string but received: "+b)}if(a.isUndefined(c)){c=null}var h={value:c,isDirty:true};b=F(g,b);j.site.data[b]=h;if(i){C(j.site.id,d,e)}else if(d){d()}}},session:{get:function(b){if(!a.isString(b)){throw new Error("Getting a session user preference expects a key of type string but received: "+b)}return a.cloneDeep(j.session.data[b])},getAll:function(){return a.cloneDeep(j.session.data)},set:function(b,c,d){if(!a.isString(b)){throw new Error("Setting a session user preference expects a key of type string but received: "+b)}j.session.data[b]=c;if(d){d()}return c}}}}return i});